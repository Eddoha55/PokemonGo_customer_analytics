---
title: "PokemonGo customer analytics"
author: '[Leonard Henriquez](https://github.com/leonard-henriquez/), [Adrien Lequiller](https://github.com/adrienlequiller) & [Eddy Ohayon](https://github.com/Eddoha55)'
date: "`r Sys.Date()`"
output: pdf_document
always_allow_html: yes
---

```{r message=FALSE, warning=FALSE, include=FALSE}
# Options
knitr::opts_chunk$set(cache = TRUE, warning=FALSE)

# Libraries
library(dplyr)
library(tidyr)
library(ggplot2)
```

First, let's start by reading the data
```{r}
# Import customers' data
customer        <- read.csv("input/customerdata.csv" )
customer$Registrationdate <- as.Date(customer$Registrationdate)
customer$fallbonus <- as.factor(customer$fallbonus)

# Import transactions
tx.fall         <- read.csv("input/fallfintrx.csv"   )
tx.summer       <- read.csv("input/summerfintrx.csv" )
tx.all <- tx.fall %>% union(tx.summer)

# Import sessions
sessions.fall   <- read.csv("input/fallsesstrx.csv"  )
sessions.summer <- read.csv("input/summersesstrx.csv")
sessions.all <- sessions.fall %>% union(sessions.summer)
```

```{r}
summary(customer)
```
```{r}
# Added monetary value of each transaction and converted data
tx.all <- tx.all %>% mutate(Value = c(2.99, 4.99, 9.99, 25, 99)[ProductID], Date = as.Date(Date))
summary(tx.all)
```


```{r}
# Calculated RFM based on all transactions (summer and fall)
# for each customer (who made at least one transaction)
customer.RFM <- tx.all %>%
  group_by(CustomerID) %>%
  summarise(Recency = max(Date), Frequency = n(), Monetary = sum(Value)) %>%
  inner_join(customer, by = 'CustomerID')
summary(customer.RFM)
```


```{r}
# Fetch all active customer
customerID.active <- sessions.summer %>% select(CustomerID) %>% distinct(CustomerID)

summary(customerID.active)
```

```{r}
# Calculate the RFM value for active customers
customer.active.RFM <- customerID.active %>%
  left_join(customer.RFM, by = "CustomerID") %>%
  mutate(Frequency = replace_na(Frequency, 0), Monetary = replace_na(Monetary, 0))

summary(customer.active.RFM)
```


```{r}
customer.active <- customer.active.RFM %>%
  left_join(customer, by = 'CustomerID') %>%
  select(-X)

customer.stats <- sessions.all %>%
  group_by(CustomerID) %>%
  select(-c(X, PlayID, Date)) %>%
  summarise_all(funs(sum))

customer.active <- customer.active %>%
  left_join(customer.stats, by = "CustomerID")

summary(customer.active)
```





```{r}
# Registration period
days_in_registration_period <- as.numeric(as.Date(max(sessions.all$Date)) - as.Date(min(as.Date(customer$Registrationdate))))

# Period of time of transactions
days_in_period <- as.numeric(as.Date(max(sessions.all$Date)) - as.Date(min(sessions.all$Date)))

total_daily_revenues <- sum(tx.all$Value) / days_in_period
total_daily_marketing_cost <- 0.15 * total_daily_revenues
total_marketing_cost_in_registration_period <- total_daily_marketing_cost * days_in_registration_period
AC = total_marketing_cost_in_registration_period / count(customer)
AC
```


```{r}
CLV <- function (r) {
  # Period of time to convert revenue to (annual) recurring revenue
  days_in_period <- as.numeric(as.Date(max(sessions.all$Date)) - as.Date(min(sessions.all$Date)))
  rr <- r * 365 / days_in_period

  # Customer value
  AC <- 0       # Customer acquisition costs
  rc <- 0       # Recurring cost
  m  <- rr - rc # Customer recurring contribution margin
  r  <- 0.5     # Retention probability for the customer
  t  <- 5       # Number of years 'out' to estimate
  d  <- 0.1     # Discount rate (Cost of Capital)

  clv <- AC
  for(i in 0:t) {
    clv <- clv+((r^i)*m/(1+d)^i)
  }
  return(clv)
}
```


```{r}
clv <- customer.active %>% mutate(CLV = CLV(Monetary))
summary(clv)
```

```{r}
ggplot(customer.active)+aes(x=CustomerType,fill=as.factor(Sex))+geom_bar()
ggplot(customer.active)+aes(x=Sex,fill=as.factor(CustomerType))+geom_bar()
```



Assignment 2, Lifecycle grids: 

In life cycle grids, we are focusing on the R & F of RFM. In other words, in frequent and recent purchases because frequency affects clientâ€™s lifetime value and recency affects retention.
The purpose therefore is to provide a target offer to specific segments or customers.

1. Introduction
#let's do lifecycle grids per player profile, gender, age, income, fallbonus

#intead of showing the number of people per segment, let's show the monetary value in $ as a fill variable

2. Improving the lifecycle grids by : 
- adding more advanced monetary metrics (CLV: current + predicted), Customer Acquisition Cost (CAC)
- Visualizing cohort analysis: try to combine customers through some common characteristics (registration date, first purchase, acquisition campaign) or split customers into homogeneous groups (first purchase cohorts, acquisition campaigns cohorts)

3. Even further: 
- Lifecycle phase sequential analysis : track how customers move from one grid to another and support them with a marketing strategy
- Delta Life Cycle Grids: compare lifecycle grids at different momments in time to evaluate the company's performance

What interests us, regarding Pokemon's objectives to increase in-app purchases is to look at the transactions in order to detec profiles of customers. 

Very first insights: 
```{r}
#Very descriptive: look at the number of customers for descriptive purposes

#per type
customer_type_number = customer %>% group_by(CustomerType) %>% summarise(Number_per_Type = n())
ggplot(customer_type_number) + aes(x=CustomerType,y=Number_per_Type) + geom_bar(stat="identity")

#per sex
customer_sex = customer %>% group_by(Sex) %>% summarise(Number_per_Sex=n())
ggplot(customer_sex) + aes(x=Sex,y=Number_per_Sex) + geom_bar(stat="identity")

#per Age 
customer_age = customer %>% group_by(Age) %>% summarise(Number_per_Age = n())
ggplot(customer_age) + aes(x=Age,y=Number_per_Age) + geom_line()

#per income
customer_income = customer %>% group_by(Income) %>% summarise(Number_per_Income = n())
ggplot(customer_income) + aes(x=Income,y=Number_per_Income) + geom_bar(stat="identity")
```

What we can deduce from those first descriptive anaylysis is that only variable Age is determinant in term of number of players. In other words, there is a massive number of players between 23 and 35 years old, a great number before 20 and very little players after 40. 
Regarding other variables there is no elements that could be helpful for the rest. 

However, despite the fact that the number of players can be different regarding some of the variables we previously took in account, we are interested here in the number of transactions and the monetary value of transactions. This is a complete different approach. 

```{r}
# creating recency and frequency groups on the 31-10-2018
# Note: lcg stands for life cycle grids
customer.LCG <- customer.RFM %>%
  mutate(segm.freq=ifelse(between(Frequency, 1, 2), '1-2',
                          ifelse(between(Frequency, 3, 5), '3-5', '>5'))) %>% mutate(segm.rec=ifelse(between(Recency, as.Date("2018-09-01"),as.Date("2018-10-31")), 'Fall', 'Summer'))

# spliting into discrete groups with levels to make & identify grids later on
customer.LCG$segm.freq <- factor(customer.LCG$segm.freq, levels=c('1-2', '3-5', '>5'))
customer.LCG$segm.rec <- factor(customer.LCG$segm.rec, levels=c('Fall', 'Summer'))

summary(customer.LCG)
```

```{r}
# first glance in terms of number of transactions
lcg.1 <- customer.LCG %>%
  group_by(segm.rec, segm.freq) %>%
  summarise(quantity=n()) %>%
  mutate(client='client') %>%
  ungroup()

ggplot(lcg.1, aes(x=client, y=quantity, fill=quantity))+
#xvalue is the client factor that is the same for all y values
  theme_bw() +
  theme(panel.grid = element_blank())+
#removes colored boxed behind bar chart
  geom_bar(stat='identity', alpha=0.6) +
#stat="identity because y is a variable in the dataset scale makes the fill transparent
  geom_text(aes(y=max(quantity)/2, label=quantity), size=4) +
#display the quantity at 50% of the height of the bar
  facet_grid(segm.freq ~ segm.rec)+
#organises the bar chart around the r & f variables
  ggtitle("LifeCycle Grids: Preview Number of transactions completed")
```

```{r}
#second glance in terms of value of transactions
lcg.2 <- customer.LCG %>% 
  group_by(segm.rec,segm.freq) %>% 
  summarise(value_ratio=round(mean(Monetary))) %>% 
  mutate(client='client') %>% 
  ungroup()

ggplot(lcg.2, aes(x=client, y=value_ratio, fill=value_ratio))+
#xvalue is the client factor that is the same for all y values
  theme_bw() +
  theme(panel.grid = element_blank())+
#removes colored boxed behind bar chart
  geom_bar(stat='identity', alpha=0.6) +
#stat="identity because y is a variable in the dataset scale makes the fill transparent
  geom_text(aes(y=max(value_ratio)/2, label=value_ratio), size=4) +
#display the quantity at 50% of the height of the bar
  facet_grid(segm.freq ~ segm.rec)+
#organises the bar chart around the r & f variables
  ggtitle("LifeCycle Grids: Preview of Value of transactions")
```

```{r}
#Focus on Customer Type

lcg.3 <- customer.LCG %>%
  group_by(segm.rec, segm.freq, CustomerType) %>%
  summarise(quantity=round(sum(Monetary)),value_ratio=round(mean(Monetary))) %>%
  ungroup()

lcg.3

ggplot(lcg.3, aes(x=CustomerType, y=quantity, fill=quantity))+
#xvalue is the client factor that is the same for all y values
  theme_bw() +
  theme(panel.grid = element_blank())+
#removes colored boxed behind bar chart
  geom_bar(stat='identity', alpha=0.6) +
#stat="identity because y is a variable in the dataset scale makes the fill transparent
  geom_text(aes(y=max(quantity)/2, label=value_ratio), size=3) +
  geom_text(aes(y=max(quantity)/3, label=quantity), size=4) +
#display the quantity at 50% of the height of the bar
  facet_grid(segm.freq ~ segm.rec)+
#organises the bar chart around the r & f variables
  ggtitle("LifeCycle Grids: Preview of Monetary Value per CustomerType")

```

```{r}
lcg.4 <- customer.LCG %>%
  group_by(segm.rec, segm.freq, fallbonus) %>%
  summarise(quantity=round(sum(Monetary)),value_ratio=round(mean(Monetary))) %>%
  ungroup()

lcg.4

ggplot(lcg.4, aes(x=fallbonus, y=quantity, fill=quantity))+
#xvalue is the client factor that is the same for all y values
  theme_bw() +
  theme(panel.grid = element_blank())+
#removes colored boxed behind bar chart
  geom_bar(stat='identity', alpha=0.6) +
#stat="identity because y is a variable in the dataset scale makes the fill transparent
  geom_text(aes(y=max(quantity)/2, label=value_ratio), size=3) +
  geom_text(aes(y=max(quantity)/3, label=quantity), size=4) +
#display the quantity at 50% of the height of the bar
  facet_grid(segm.freq ~ segm.rec)+
#organises the bar chart around the r & f variables
  ggtitle("LifeCycle Grids: Preview of Monetary Value per FallBonus")
```


Let's create more categories of Age regarding the first graph we found : 
```{r}
# As we saw in the preliminitary work, there is huge difference for age, and we can categorise them 
#as 7-23, 24-35, 36-50 and above 51
customer.LCG = customer.LCG %>%
  mutate(Age=ifelse(between(Age, 6, 23), '6-23',
                          ifelse(between(Age, 24, 35), '24-35',
                                 ifelse(between(Age, 36, 50), '36-50', '>51'))))
customer.LCG$Age <- factor(customer.LCG$Age, levels=c('6-23', '24-35', '36-50', '>51'))
customer.LCG
```

```{r}
#Focus on Customer Type

lcg.5 <- customer.LCG %>%
  group_by(segm.rec, segm.freq, Age) %>%
  summarise(quantity=round(sum(Monetary)),value_ratio=round(mean(Monetary))) %>%
  ungroup()

lcg.5

ggplot(lcg.5, aes(x=Age, y=quantity, fill=quantity))+
#xvalue is the client factor that is the same for all y values
  theme_bw() +
  theme(panel.grid = element_blank())+
#removes colored boxed behind bar chart
  geom_bar(stat='identity', alpha=0.6) +
#stat="identity because y is a variable in the dataset scale makes the fill transparent
  geom_text(aes(y=max(quantity)/2, label=value_ratio), size=3) +
  geom_text(aes(y=max(quantity)/3, label=quantity), size=4) +
#display the quantity at 50% of the height of the bar
  facet_grid(segm.freq ~ segm.rec)+
#organises the bar chart around the r & f variables
  ggtitle("LifeCycle Grids: Preview of Monetary Value per Age")
```

